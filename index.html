<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>大衍筮法 · 写实分堆（交互起卦·无撤销）</title>
<meta name="description" content="严格还原：每一爻点击三次“分堆”（分二→挂一→按四取余，余0记4），六爻成卦；强随机（crypto）；显示64卦卦名；无种子、无导出、无撤销。" />
<style>
  :root { --bg:#fafafa; --fg:#111; --muted:#6b7280; --card:#fff; --line:#111; --accent:#111; --ok:#065f46; --warn:#b45309; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  h1{font-size:22px;margin:0 0 8px} p.lead{margin:0 0 18px;color:var(--muted)}
  .row{display:grid;gap:16px;grid-template-columns:1fr} @media(min-width:980px){.row{grid-template-columns:1.2fr 0.8fr}}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .btn{cursor:pointer;border:none;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px}
  .btn.secondary{background:#11111110;color:var(--fg);border:1px solid #00000020}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .muted{color:var(--muted)} .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Courier New",monospace}
  .grid2{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:700px){.grid2{grid-template-columns:1fr 1fr}}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .pill{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:13px}
  .lines{display:flex;flex-direction:column;gap:8px}
  .one-line{display:flex;align-items:center;gap:10px}
  .yang,.yin{position:relative;height:8px;width:220px}
  .yang::before{content:"";position:absolute;inset:0;background:var(--line);border-radius:2px}
  .yin{display:flex;justify-content:space-between;align-items:center}
  .yin .seg{height:8px;background:var(--line);width:44%} .yin .gap{width:12%}
  .tag{font-size:12px;color:#fff;background:#111;border-radius:6px;padding:1px 6px;margin-left:6px}
  .ok{color:var(--ok)} .warn{color:#b45309}
  pre{white-space:pre-wrap;font-size:12px;background:#f7f7f7;border:1px solid #eee;border-radius:10px;padding:10px;overflow:auto}
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0b0b; --fg:#eee; --muted:#9ca3af; --card:#111; --line:#e5e7eb; --accent:#e5e7eb; }
    .btn.secondary{ background:#ffffff10; border-color:#ffffff20; color:var(--fg); }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>大衍筮法 · 写实分堆（交互起卦·无撤销）</h1>
  <p class="lead">每一爻需 <span class="mono">3 次变</span>：第1变先“挂一”，每变“分二且非空”，按四取余（余0记4）。点击三次得一爻，六爻成卦。</p>

  <div class="row">
    <!-- 左：交互操作与过程 -->
    <div class="card">
      <div class="kpi">
        <div class="pill">模式：写实分堆（A 等可能）</div>
        <div class="pill">RNG：强随机</div>
        <div class="pill">VRS：<span class="mono" id="vrs">—</span></div>
        <div class="pill">版本：<span class="mono" id="verpill">—</span></div>
      </div>

      <!-- 指导说明 -->
      <div class="card" style="margin-bottom:10px">
        <div style="font-weight:600;margin-bottom:6px">指导说明</div>
        <ol class="small" style="margin:0 0 6px 18px; padding:0; line-height:1.6">
          <li>点击<b>开始一卦</b>。</li>
          <li>每一爻需<b>三次</b>点击<b>分堆一次（下一变）</b>：
            第1变会先<b>挂一</b>，每变都按四取余（余0记4）。</li>
          <li>三变完成即得到该爻（6/7/8/9）。随后点击<b>开始下一爻</b>，直到凑满六爻。</li>
          <li>本版<b>不支持撤销</b>；若需重来，请点<b>重开</b>。</li>
          <li>完成六爻后，右侧会显示：本卦/之卦/互卦/错卦/综卦与对应的<b>64卦卦名</b>。</li>
          <li>采用<b>强随机</b>；不提供种子、导出、复制。</li>
        </ol>
        <div class="small muted">提示：下方“当前爻”区域会实时展示每一步的 A/B 分堆、取余与剩余。</div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px" role="group" aria-label="交互控制">
        <button class="btn" id="startHex">开始一卦</button>
        <button class="btn" id="splitOnce" disabled>分堆一次（下一变）</button>
        <button class="btn secondary" id="nextLine" disabled>开始下一爻</button>
        <button class="btn secondary" id="resetAll">重开</button>
      </div>

      <div id="status" class="muted small">未开始。</div>

      <div class="grid2" style="margin-top:12px">
        <div class="card">
          <div style="font-weight:600;margin-bottom:6px">当前爻（自下而上）</div>
          <div id="currInfo" class="small mono"></div>
          <pre id="currDetail"></pre>
        </div>
        <div class="card">
          <div style="font-weight:600;margin-bottom:6px">已成爻（从下到上）</div>
          <div id="builtLines" class="lines"></div>
          <div class="small muted" id="builtText"></div>
        </div>
      </div>
    </div>

    <!-- 右：结果展示 -->
    <div class="card">
      <div style="font-weight:600;margin-bottom:6px" id="labelMain">本卦</div>
      <div id="mainHex" class="lines"></div>
      <div class="small muted" id="triMain"></div>

      <div style="height:12px"></div>

      <div style="font-weight:600;margin-bottom:6px" id="labelRel">之卦</div>
      <div id="relHex" class="lines"></div>
      <div class="small muted" id="triRel"></div>

      <div style="height:12px"></div>

      <div style="font-weight:600;margin-bottom:6px">互卦 / 错卦 / 综卦（含卦名与二进制）</div>
      <div class="small mono" id="moreHex"></div>
    </div>
  </div>

  <p class="small muted" style="margin-top:16px">
    注：动爻＝6（老阴）、9（老阳）；之卦＝动位翻转（6→阳、9→阴）。互卦：二三四为下、三四五为上；错卦：阴阳互换；综卦：六爻倒置。
    八卦映射（底→顶）：乾111、兑110、离101、震100、巽011、坎010、艮001、坤000。
  </p>
</div>

<script>
/* ========= 版本与构建 ========= */
const APP_VERSION = "v3.2.0-interactive-noundo";
let   BUILD_SHA256 = "";
const __appendVersionToCommit = true;

async function sha256Hex(s){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest("SHA-256", enc.encode(s));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join(""); }
async function computeBuildHashOnce(){
  if (BUILD_SHA256) return BUILD_SHA256;
  BUILD_SHA256 = await sha256Hex(document.documentElement.outerHTML);
  return BUILD_SHA256;
}
function cryptoNonceHex(bytes=16){ const u=new Uint8Array(bytes); crypto.getRandomValues(u); return Array.from(u).map(b=>b.toString(16).padStart(2,"0")).join(""); }

/* ========= 强随机 RNG ========= */
function cryptoRng(){ const u32=new Uint32Array(1); return ()=>{ crypto.getRandomValues(u32); return (u32[0]>>>0)/2**32; }; }
function randIntInclusive(rng,a,b){ const u=rng(); return Math.floor(u*(b-a+1))+a; }

/* ========= 写实分堆（严格三变） ========= */
function rem4NonZero(x){ const r=x%4; return r===0?4:r; }
function splitNonZero(total, rng){ const A=randIntInclusive(rng,1,total-1); return [A,total-A]; }
function firstChange(n, rng){
  const [A,B] = splitNonZero(n, rng);
  const leftRem  = rem4NonZero(A);
  const rightRem = rem4NonZero(B-1); // 先挂一
  const taken = 1 + leftRem + rightRem; // 5 或 9
  return { after:n-taken, step:{from:n,to:n-taken,A,B,leftRem,rightRem,taken,kind:"第1变（挂一）"} };
}
function nextChange(n, rng){
  const [A,B] = splitNonZero(n, rng);
  const leftRem  = rem4NonZero(A);
  const rightRem = rem4NonZero(B);
  const taken = leftRem + rightRem; // 4 或 8
  return { after:n-taken, step:{from:n,to:n-taken,A,B,leftRem,rightRem,taken,kind:"后续变"} };
}
function remainingToLine(n){
  if(n===24) return 6;
  if(n===28) return 7;
  if(n===32) return 8;
  if(n===36) return 9;
  throw new Error("Unexpected remainder: "+n);
}
function genOneStep(n, idx, rng){
  return (idx===1) ? firstChange(n, rng) : nextChange(n, rng);
}

/* ========= 卦运算 & 名称 ========= */
function isYang(v){ return v===7||v===9; }
function toBinary(lines){ return lines.map(v=>isYang(v)?1:0); } // 底→顶
function relatingFrom(lines){ const out=lines.slice(); for(let i=0;i<6;i++){ if(lines[i]===6) out[i]=7; else if(lines[i]===9) out[i]=8; } return out; }
function nuclearFromBinary(b){ return [b[1],b[2],b[3], b[2],b[3],b[4]]; }
function invertedFromBinary(b){ return [b[5],b[4],b[3],b[2],b[1],b[0]]; }
function oppositeFromBinary(b){ return b.map(x=>x?0:1); }

const TRIS = {
  "111":{zh:"乾",sym:"☰"}, "110":{zh:"兑",sym:"☱"}, "101":{zh:"离",sym:"☲"}, "100":{zh:"震",sym:"☳"},
  "011":{zh:"巽",sym:"☴"}, "010":{zh:"坎",sym:"☵"}, "001":{zh:"艮",sym:"☶"}, "000":{zh:"坤",sym:"☷"},
};
function triNameOf(b3){ const k=b3.join(""); return TRIS[k]?`${TRIS[k].sym}${TRIS[k].zh}`:k; }
function trisOf(bin){ const lower=bin.slice(0,3), upper=bin.slice(3,6); return {lower,upper}; }

const HEX64 = {
"111111":{no:1,zh:"乾",full:"乾为天"},"000000":{no:2,zh:"坤",full:"坤为地"},"100010":{no:3,zh:"屯",full:"水雷屯"},
"010001":{no:4,zh:"蒙",full:"山水蒙"},"111010":{no:5,zh:"需",full:"水天需"},"010111":{no:6,zh:"讼",full:"天水讼"},
"010000":{no:7,zh:"师",full:"地水师"},"000010":{no:8,zh:"比",full:"水地比"},"111011":{no:9,zh:"小畜",full:"风天小畜"},
"110111":{no:10,zh:"履",full:"天泽履"},"111000":{no:11,zh:"泰",full:"地天泰"},"000111":{no:12,zh:"否",full:"天地否"},
"101111":{no:13,zh:"同人",full:"天火同人"},"111101":{no:14,zh:"大有",full:"火天大有"},"001000":{no:15,zh:"谦",full:"地山谦"},
"000100":{no:16,zh:"豫",full:"雷地豫"},"100110":{no:17,zh:"随",full:"泽雷随"},"011001":{no:18,zh:"蛊",full:"山风蛊"},
"110000":{no:19,zh:"临",full:"地泽临"},"000011":{no:20,zh:"观",full:"风地观"},"100101":{no:21,zh:"噬嗑",full:"火雷噬嗑"},
"101001":{no:22,zh:"贲",full:"山火贲"},"000001":{no:23,zh:"剥",full:"山地剥"},"100000":{no:24,zh:"复",full:"地雷复"},
"100111":{no:25,zh:"无妄",full:"天雷无妄"},"111001":{no:26,zh:"大畜",full:"山天大畜"},"100001":{no:27,zh:"颐",full:"山雷颐"},
"011110":{no:28,zh:"大过",full:"泽风大过"},"010010":{no:29,zh:"坎",full:"坎为水"},"101101":{no:30,zh:"离",full:"离为火"},
"001110":{no:31,zh:"咸",full:"泽山咸"},"011100":{no:32,zh:"恒",full:"雷风恒"},"001111":{no:33,zh:"遯",full:"天山遯"},
"111100":{no:34,zh:"大壮",full:"雷天大壮"},"000101":{no:35,zh:"晋",full:"火地晋"},"101000":{no:36,zh:"明夷",full:"地火明夷"},
"101011":{no:37,zh:"家人",full:"风火家人"},"110101":{no:38,zh:"睽",full:"火泽睽"},"001010":{no:39,zh:"蹇",full:"水山蹇"},
"010100":{no:40,zh:"解",full:"雷水解"},"110001":{no:41,zh:"损",full:"山泽损"},"100011":{no:42,zh:"益",full:"风雷益"},
"111110":{no:43,zh:"夬",full:"泽天夬"},"011111":{no:44,zh:"姤",full:"天风姤"},"000110":{no:45,zh:"萃",full:"泽地萃"},
"011000":{no:46,zh:"升",full:"地风升"},"010110":{no:47,zh:"困",full:"泽水困"},"011010":{no:48,zh:"井",full:"水风井"},
"101110":{no:49,zh:"革",full:"泽火革"},"011101":{no:50,zh:"鼎",full:"火风鼎"},"100100":{no:51,zh:"震",full:"震为雷"},
"001001":{no:52,zh:"艮",full:"艮为山"},"001011":{no:53,zh:"渐",full:"风山渐"},"110100":{no:54,zh:"归妹",full:"雷泽归妹"},
"101100":{no:55,zh:"丰",full:"雷火丰"},"001101":{no:56,zh:"旅",full:"火山旅"},"011011":{no:57,zh:"巽",full:"巽为风"},
"110110":{no:58,zh:"兑",full:"兑为泽"},"010011":{no:59,zh:"涣",full:"风水涣"},"110010":{no:60,zh:"节",full:"水泽节"},
"110011":{no:61,zh:"中孚",full:"风泽中孚"},"001100":{no:62,zh:"小过",full:"雷山小过"},"101010":{no:63,zh:"既济",full:"水火既济"},
"010101":{no:64,zh:"未济",full:"火水未济"},
};
function hexInfoOf(bin){ const k=Array.isArray(bin)?bin.join(""):String(bin); return HEX64[k]||null; }
function hexLabel(bin){ const i=hexInfoOf(bin); return i?`${i.no}. ${i.full}「${i.zh}」`:`未收录（${Array.isArray(bin)?bin.join(""):bin}）`; }

/* ========= UI 获取 ========= */
const $ = s=>document.querySelector(s);
const elStart=$("#startHex"), elSplit=$("#splitOnce"), elNextLine=$("#nextLine"), elReset=$("#resetAll");
const elStatus=$("#status");
const elCurrInfo=$("#currInfo"), elCurrDetail=$("#currDetail");
const elBuilt=$("#builtLines"), elBuiltText=$("#builtText");
const elMain=$("#mainHex"), elRel=$("#relHex"), elTriM=$("#triMain"), elTriR=$("#triRel"), elMore=$("#moreHex");
const elLabelMain=$("#labelMain"), elLabelRel=$("#labelRel");
const elVRS=$("#vrs"), verpill=$("#verpill");

/* ========= 渲染 ========= */
function renderOneLineVisual(v){
  const row=document.createElement("div"); row.className="one-line";
  const isY=(v===7||v===9), moving=(v===6||v===9);
  if(isY){ const bar=document.createElement("div"); bar.className="yang"; row.appendChild(bar); }
  else{ const yin=document.createElement("div"); yin.className="yin";
        const s1=document.createElement("div"); s1.className="seg";
        const gap=document.createElement("div"); gap.className="gap";
        const s2=document.createElement("div"); s2.className="seg"; yin.append(s1,gap,s2); row.appendChild(yin); }
  const lab=document.createElement("div"); lab.className="small mono"; lab.textContent=String(v);
  if(moving){ const t=document.createElement("span"); t.className="tag"; t.textContent="动"; lab.appendChild(t); }
  row.appendChild(lab); return row;
}
function renderLines(container, lines){
  container.innerHTML=""; const visual=lines.slice().reverse(); visual.forEach(v=>container.appendChild(renderOneLineVisual(v)));
}
function renderBuilt(lines){
  elBuilt.innerHTML="";
  if(!lines.length){ elBuiltText.textContent="尚无成爻。"; return; }
  // 从下到上（不倒序）
  lines.forEach(v=> elBuilt.appendChild(renderOneLineVisual(v)));
  elBuiltText.textContent = `（已成 ${lines.length}/6 爻；从下到上：${lines.join(", ")}）`;
}
function renderTris(el, bin){
  const {lower,upper}=trisOf(bin);
  el.textContent=`下卦：${triNameOf(lower)}　上卦：${triNameOf(upper)}　（二进制 底→顶：${bin.join("")})`;
}
function renderMore(el,bMain){
  const bNuc=nuclearFromBinary(bMain), bOpp=oppositeFromBinary(bMain), bInv=invertedFromBinary(bMain);
  const line=(label,b)=>`${label}：${triNameOf(b.slice(0,3))}/${triNameOf(b.slice(3,6))}  ${b.join("")} ｜ ${hexLabel(b)}`;
  el.textContent=[ line("互卦",bNuc), line("错卦",bOpp), line("综卦",bInv) ].join("\n");
}

/* ========= 交互状态 ========= */
const state = {
  rng: cryptoRng(),
  sessionNonce: "", // 每次“开始一卦”生成
  lines: [],        // 已成爻（底→顶）
  hexDetail: [],    // 每爻三变明细
  curr: null,       // { n, stepIdx(1..3), steps:[] }
  finished: false,
};

function resetAll(){
  state.rng = cryptoRng();
  state.sessionNonce = "";
  state.lines = [];
  state.hexDetail = [];
  state.curr = null;
  state.finished = false;
  elStatus.textContent = "未开始。";
  elCurrInfo.textContent = "";
  elCurrDetail.textContent = "";
  elMain.innerHTML = elRel.innerHTML = elMore.textContent = "";
  elTriM.textContent = elTriR.textContent = "";
  elLabelMain.textContent="本卦"; elLabelRel.textContent="之卦";
  renderBuilt(state.lines);
  elSplit.disabled = elNextLine.disabled = true;
}

function startHex(){
  state.sessionNonce = cryptoNonceHex(16);
  state.lines = [];
  state.hexDetail = [];
  state.finished = false;
  startNewLine();
  elStatus.innerHTML = `已开始本卦。<span class="ok">当前爻：第 ${state.lines.length+1} 爻（自下而上）</span>`;
}

function startNewLine(){
  state.curr = { n:49, stepIdx:1, steps:[] };
  updateCurrUI();
  elSplit.disabled = false; elNextLine.disabled = true;
}

function updateCurrUI(){
  if(!state.curr){ elCurrInfo.textContent=""; elCurrDetail.textContent=""; return; }
  const idx = state.lines.length + 1;
  elCurrInfo.textContent = `当前爻：第 ${idx} 爻｜现有蓍草数 n=${state.curr.n}｜下一步：${state.curr.stepIdx===1?"第1变（先挂一）":"第"+state.curr.stepIdx+"变"}`;
  const display = state.curr.steps.map((s,i)=>({
    变序:i+1, 从:s.from, 到:s.to, A:s.A, B:s.B, 左余:s.leftRem, 右余:s.rightRem, 取走:s.taken, 标注:s.kind
  }));
  elCurrDetail.textContent = display.length ? JSON.stringify(display, null, 2) : "（等待分堆）";
}

function doOneSplit(){
  const {n, stepIdx} = state.curr;
  const {after, step} = genOneStep(n, stepIdx, state.rng);
  step.idx = stepIdx;
  state.curr.steps.push(step);
  state.curr.n = after;
  state.curr.stepIdx++;

  if (state.curr.stepIdx===4){
    // 三变完成，得到一爻
    const value = remainingToLine(state.curr.n);
    state.lines.push(value);
    state.hexDetail.push({ line: state.lines.length, value, remainder: state.curr.n, steps: state.curr.steps.slice() });

    renderBuilt(state.lines);
    elStatus.innerHTML = `第 ${state.lines.length} 爻已成：<b>${value}</b>（${(value===7||value===9)?"阳":"阴"}${(value===6||value===9)?"·动":""}）。`;
    state.curr = null;

    // 下一步：下一爻 or 完成全卦
    elSplit.disabled = true;
    if (state.lines.length < 6){
      elNextLine.disabled = false;
      elCurrInfo.textContent = "本爻完成。点击“开始下一爻”。";
      elCurrDetail.textContent = "";
    }else{
      elNextLine.disabled = true;
      finishHex();
    }
  }else{
    updateCurrUI();
  }
}

async function finishHex(){
  // 计算与渲染
  const binMain = toBinary(state.lines);
  const relating = relatingFrom(state.lines);
  const binRel  = toBinary(relating);

  renderLines(elMain, state.lines);
  renderLines(elRel, relating);
  renderTris(elTriM, binMain);
  renderTris(elTriR, binRel);
  if (elLabelMain) elLabelMain.textContent = `本卦：` + hexLabel(binMain);
  if (elLabelRel)  elLabelRel.textContent  = `之卦：` + hexLabel(binRel);

  const bNuc = nuclearFromBinary(binMain);
  const bOpp = oppositeFromBinary(binMain);
  const bInv = invertedFromBinary(binMain);
  const line = (label,b)=>`${label}：${triNameOf(b.slice(0,3))}/${triNameOf(b.slice(3,6))}  ${b.join("")} ｜ ${hexLabel(b)}`;
  elMore.textContent = [ line("互卦",bNuc), line("错卦",bOpp), line("综卦",bInv) ].join("\n");

  state.finished = true;

  // VRS：对本卦全过程做承诺（仅标记，不提供复现导出）
  await computeBuildHashOnce();
  const bodyHash = await sha256Hex(JSON.stringify({lines:state.lines, detail:state.hexDetail}));
  const commitStr = (__appendVersionToCommit ? `${APP_VERSION}|${BUILD_SHA256}|` : "") + `nonce:${state.sessionNonce}|body:${bodyHash}`;
  elVRS.textContent = (await sha256Hex(commitStr)).slice(0,16)+"…";

  elStatus.innerHTML = `<span class="ok">全卦完成。</span> 右侧可查看“本卦/之卦/互错综”的卦名与结构。`;
}

/* ========= 事件 ========= */
elStart.addEventListener("click", ()=>{ startHex(); });
elSplit.addEventListener("click", ()=>{ if(state.curr) doOneSplit(); });
elNextLine.addEventListener("click", ()=>{ if(!state.curr && state.lines.length<6) { startNewLine(); elStatus.innerHTML = `继续起卦。当前爻：第 ${state.lines.length+1} 爻（自下而上）`; } });
elReset.addEventListener("click", ()=> resetAll());

/* ========= 初始化 ========= */
(async function init(){
  await computeBuildHashOnce();
  if (verpill) verpill.textContent = APP_VERSION+" · "+(BUILD_SHA256||"").slice(0,8)+"…";
  resetAll();
})();
</script>
</body>
</html>
