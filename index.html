<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="color-scheme" content="light dark">
<title>å¤§è¡ç­®æ³• Â· å†™å®åˆ†å †</title>
<meta name="description" content="ä¸¥æ ¼è¿˜åŸï¼šä¸‰å˜ä¸€çˆ»ï¼ˆåˆ†äºŒâ†’æŒ‚ä¸€â†’æŒ‰å››å–ä½™ï¼Œä½™0è®°4ï¼‰ï¼Œå…­çˆ»æˆå¦ï¼›å¼ºéšæœºï¼›æ˜¾ç¤º64å¦å¦åï¼›å«â€˜æŒ‡å—/è§£å¦ï¼ˆæœ±ç†¹ï¼‰â€™ï¼›â€˜å·²æˆçˆ»â€™è‡ªä¸‹è€Œä¸Šæ˜¾ç¤ºã€‚">
<style>
  :root{
    --bg:#fafafa; --fg:#111; --muted:#6b7280; --card:#fff; --line:#111; --accent:#111; --ok:#065f46; --warn:#b45309;
    --code-bg:#f7f7f7; --code-fg:#111; --code-border:#e5e7eb; --chip-border:#d1d5db;
    --tip-bg:#f8fafc; --tip-border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  h1{font-size:22px;margin:0 0 8px}

  .row{display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:980px){.row{grid-template-columns:1.2fr 0.8fr}}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}

  .btn{cursor:pointer;border:none;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px}
  .btn.secondary{background:#11111110;color:var(--fg);border:1px solid #00000020}
  .btn.ghost{background:transparent;border:1px dashed #00000030;color:var(--fg)}
  .btn.small{padding:6px 10px;font-size:13px;border-radius:8px}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  /* çªå‡ºä¸»æ‰“æŒ‰é’®ï¼ˆæŒ‡å—/è§£å¦ï¼‰ */
  .btn.prominent{padding:12px 16px;border-radius:12px;font-weight:600;box-shadow:0 1px 0 rgba(0,0,0,.08)}
  .btn.prominent:disabled{opacity:.65}
  #methodBtn:disabled{opacity:.45; filter:saturate(.75)} /* è§£å¦ç¦ç”¨ï¼šæ›´æ·¡ä¸€ç‚¹ */

  .muted{color:var(--muted)} .small{font-size:12px} .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Courier New",monospace}
  .grid2{display:grid;gap:12px;grid-template-columns:1fr}
  @media(min-width:700px){.grid2{grid-template-columns:1fr 1fr}}

  /* KPI åŒºæ·¡åŒ– */
  .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
  .pill{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;font-size:12px}
  .pill.dim{background:transparent;border-style:dashed;color:var(--muted);opacity:.8}

  .lines{display:flex;flex-direction:column;gap:8px}
  .lines.bottom-up{flex-direction:column-reverse}
  .one-line{display:flex;align-items:center;gap:10px}
  .yang,.yin{position:relative;height:8px;width:220px}
  .yang::before{content:"";position:absolute;inset:0;background:var(--line);border-radius:2px}
  .yin{display:flex;justify-content:space-between;align-items:center}
  .yin .seg{height:8px;background:var(--line);width:44%} .yin .gap{width:12%}
  .tag{font-size:12px;color:#fff;background:#111;border-radius:6px;padding:1px 6px;margin-left:6px}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
  pre{
    white-space:pre-wrap;font-size:12px;font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Courier New",monospace;
    background:var(--code-bg);color:var(--code-fg);border:1px solid var(--code-border);
    border-radius:10px;padding:10px;overflow:auto;line-height:1.6;max-height:44vh;word-break:break-word;
  }
  a.linkchip{display:inline-block;margin:6px 6px 0 0;padding:5px 9px;border-radius:999px;border:1px solid var(--chip-border);background:#fff;color:#111;text-decoration:none;font-size:12px}
  a.linkchip:hover{box-shadow:0 1px 0 rgba(0,0,0,.08)}

  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50}
  .modal > .box{max-width:760px;margin:7vh auto;background:#fff;border-radius:12px;padding:16px;outline:none}
  .modal .title{font-weight:600;margin-bottom:8px}
  .hr{height:1px;background:#e5e7eb;margin:10px 0}
  .caps{font-variant-caps: all-small-caps; letter-spacing:.5px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .toolbar .sep{flex:1}
  .checkbox{display:inline-flex;gap:6px;align-items:center;font-size:12px}
  details.hint{margin-top:12px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
  details.hint>summary{cursor:pointer;outline:none}

  /* è§£å¦é¢æ¿å†…çš„ AI æç¤º */
  .ai-tip{margin-top:8px;background:var(--tip-bg);border:1px dashed var(--tip-border);border-radius:10px;padding:8px 10px}

  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b0b0b; --fg:#eee; --muted:#9ca3af; --card:#111; --line:#e5e7eb; --accent:#e5e7eb;
      --code-bg:#0f0f0f; --code-fg:#e5e7eb; --code-border:#222; --chip-border:#2a2a2a;
      --tip-bg:#0f1113; --tip-border:#222;
    }
    .card{ border-color:#222 }
    .btn{ background:var(--accent); color:#111; }
    .btn.secondary,.btn.ghost{ background:#ffffff10; border-color:#ffffff30; color:var(--fg); }
    .pill{ background:#1a1a1a; border-color:#2a2a2a; color:var(--fg); }
    .pill.dim{ background:transparent; border-color:#2a2a2a; color:var(--muted); }
    input,select,textarea{ background:#0f0f0f; color:var(--fg); border:1px solid #2a2a2a; border-radius:10px; padding:8px 10px; }
    .modal > .box{ background:#111; color:var(--fg); }
    .hr{ background:#222 }
    a.linkchip{ background:#1a1a1a; border-color:#2a2a2a; color:#e5e7eb; }
    details.hint{ background:#0f1113; border-color:#222; }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>å¤§è¡ç­®æ³• Â· å†™å®åˆ†å †</h1>

  <div class="row">
    <!-- å·¦ï¼šäº¤äº’ -->
    <div class="card" aria-label="äº¤äº’ä¸è¿‡ç¨‹">

      <!-- KPIï¼šæ·¡åŒ– -->
      <div class="kpi">
        <div class="pill dim">æ¨¡å¼ï¼šå†™å®åˆ†å †ï¼ˆA ç­‰å¯èƒ½ï¼‰</div>
        <div class="pill dim">RNGï¼šå¼ºéšæœº</div>
        <div class="pill dim">VRSï¼š<span class="mono" id="vrs">â€”</span></div>
        <div class="pill dim">ç‰ˆæœ¬ï¼š<span class="mono" id="verpill">â€”</span></div>
      </div>

      <!-- æ§åˆ¶åŒºï¼šæŒ‡å—æœ€å‰ï¼›è§£å¦ï¼ˆæœ±ç†¹ï¼‰æ”¾åˆ°æœ€å -->
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px" role="group" aria-label="äº¤äº’æ§åˆ¶">
        <button class="btn prominent" id="guideBtn" aria-haspopup="dialog" aria-controls="guideModal">æŒ‡å—</button>

        <button class="btn" id="startHex">å¼€å§‹ä¸€å¦</button>
        <button class="btn" id="splitOnce" disabled title="æ¯ç‚¹ä¸€æ¬¡å®Œæˆä¸€å˜ï¼Œä¸‰å˜æˆä¸€çˆ»">åˆ†å †ï¼ˆä¸‹ä¸€å˜ï¼‰</button>
        <button class="btn secondary" id="nextLine" disabled title="æœ¬çˆ»å®Œæˆåå¼€å§‹ä¸‹ä¸€çˆ»">å¼€å§‹ä¸‹ä¸€çˆ»</button>
        <button class="btn secondary" id="resetAll" title="ä»å¤´å†æ¥">é‡å¼€</button>

        <span style="flex:1"></span>
        <button class="btn prominent" id="methodBtn" aria-haspopup="dialog" aria-controls="methodModal" disabled>è§£å¦ï¼ˆæœ±ç†¹ï¼‰</button>
      </div>

      <div id="status" class="muted small">æœªå¼€å§‹ã€‚ç‚¹å‡»â€œå¼€å§‹ä¸€å¦â€ã€‚</div>

      <div class="grid2" style="margin-top:12px">
        <div class="card" aria-label="å½“å‰çˆ»">
          <div style="font-weight:600;margin-bottom:6px">å½“å‰çˆ»ï¼ˆè‡ªä¸‹è€Œä¸Šï¼‰</div>
          <div id="currInfo" class="small mono"></div>
          <pre id="currDetail" aria-live="polite"></pre>
        </div>
        <div class="card" aria-label="å·²æˆçˆ»">
          <div style="font-weight:600;margin-bottom:6px">å·²æˆçˆ»ï¼ˆä»ä¸‹è€Œä¸Šå®æ—¶å †å ï¼‰</div>
          <div id="builtLines" class="lines bottom-up"></div>
          <div class="small muted" id="builtText"></div>
        </div>
      </div>
    </div>

    <!-- å³ï¼šç»“æœ -->
    <div class="card" aria-label="ç»“æœä¸é“¾æ¥">
      <div style="font-weight:600;margin-bottom:6px" id="labelMain">æœ¬å¦</div>
      <div id="mainHex" class="lines"></div>
      <div class="small muted" id="triMain"></div>
      <div id="linksMain" class="small"></div>

      <div style="height:12px"></div>

      <div style="font-weight:600;margin-bottom:6px" id="labelRel">ä¹‹å¦</div>
      <div id="relHex" class="lines"></div>
      <div class="small muted" id="triRel"></div>
      <div id="linksRel" class="small"></div>

      <div class="toolbar">
        <label class="checkbox"><input type="checkbox" id="includeSteps"> åŒ…å«ä¸‰å˜æ˜ç»†</label>
        <button class="btn small" id="copyBtn" disabled>å¤åˆ¶ç»“æœ</button>
        <span class="sep"></span>
      </div>

      <details class="hint">
        <summary>æœ¯è¯­æç¤º</summary>
        <div class="small" style="margin-top:6px">
          åŠ¨çˆ»ï¼6ï¼ˆè€é˜´ï¼‰/9ï¼ˆè€é˜³ï¼‰ï¼›é˜³çˆ»ï¼7/9ï¼Œé˜´çˆ»ï¼6/8ã€‚ä¹‹å¦ï¼æŠŠåŠ¨ä½ç¿»è½¬ï¼ˆ6â†’é˜³ã€9â†’é˜´ï¼‰ã€‚<br>
          äº’å¦ï¼šå–2-4ä¸3-5ä¸ºä¸Šä¸‹ï¼›é”™å¦ï¼šé˜´é˜³äº’æ¢ï¼›ç»¼å¦ï¼šå…­çˆ»å€’ç½®ã€‚<br>
          å…«å¦ï¼ˆåº•â†’é¡¶ï¼‰ï¼šä¹¾111ã€å…‘110ã€ç¦»101ã€éœ‡100ã€å·½011ã€å010ã€è‰®001ã€å¤000ã€‚
        </div>
      </details>

      <div style="height:12px"></div>

      <div style="font-weight:600;margin-bottom:6px" title="äº’ï¼šå–2-4ä¸3-5ä¸ºä¸Šä¸‹ï¼›é”™ï¼šé˜´é˜³å€’æ¢ï¼›ç»¼ï¼šå…­çˆ»å€’ç½®">äº’å¦ / é”™å¦ / ç»¼å¦ï¼ˆå«å¦åä¸äºŒè¿›åˆ¶ï¼‰</div>
      <div class="small mono" id="moreHex"></div>
    </div>
  </div>

  <!-- è‡ªæ£€ -->
  <div class="card" style="margin-top:16px" aria-label="åˆ†å¸ƒè‡ªæ£€">
    <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
      <div style="flex:1;min-width:230px">
        <label for="N" class="small muted">åˆ†å¸ƒè‡ªæ£€æ ·æœ¬é‡ï¼ˆå»ºè®® â‰¥ 100000ï¼‰</label>
        <input id="N" type="number" value="100000" min="1000" step="1000" />
      </div>
      <button id="selftest" class="btn secondary">è¿è¡Œè‡ªæ£€</button>
    </div>
    <div id="check" style="margin-top:12px;display:none">
      <div class="small muted">
        å‚è€ƒè¶‹åŠ¿ï¼š<b>9 â‰¥ 8 â‰« 7 > 6</b>ï¼›ç»éªŒåŸºå‡†çº¦
        <span class="mono">6â‰ˆ1.3%ï¼Œ7â‰ˆ12.8%ï¼Œ8â‰ˆ41.6%ï¼Œ9â‰ˆ44.3%</span>ï¼ˆä»…ä½œå¥åº·æ£€æŸ¥ï¼‰ã€‚
      </div>
      <pre id="stat" class="mono" aria-live="polite"></pre>
      <div id="statWarn" class="small warn"></div>
    </div>
  </div>
</div>

<!-- æŒ‡å—ï¼ˆé‡å†™ï¼šæµç¨‹å¼•å¯¼ + æ–‡åŒ–ç®€ä»‹ + AI å…œåº•ï¼‰ -->
<div class="modal" id="guideModal" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
  <div class="box" tabindex="-1">
    <div id="guideTitle" class="title">æŒ‡å— Â· ä¸€çœ‹å°±ä¼š</div>
    <div class="hr"></div>

    <div class="small" style="line-height:1.85">
      <b>å¦‚ä½•ä½¿ç”¨ Â· å¸¦ä½ èµ°å®Œä¸€é</b><br>
      1ï¼‰<b>æƒ³æ¸…æ¥šé—®é¢˜</b>ï¼šèšç„¦ã€å…·ä½“ï¼ˆå¦‚â€œä»Šå¤©æ˜¯å¦é€‚åˆå‡ºè¡Œï¼Ÿâ€ï¼‰ã€‚<br>
      2ï¼‰ç‚¹<b>å¼€å§‹ä¸€å¦</b>ã€‚<br>
      3ï¼‰å¯¹<b>æ¯ä¸€çˆ»</b>è¿ç‚¹<b>åˆ†å †</b><u>ä¸‰æ¬¡</u>ï¼ˆç¬¬ 1 æ¬¡ä¼šè‡ªåŠ¨â€œæŒ‚ä¸€â€ï¼‰ï¼Œå®Œæˆåç‚¹<b>å¼€å§‹ä¸‹ä¸€çˆ»</b>ã€‚<br>
      4ï¼‰å…­çˆ»æˆå¦åï¼Œå³ä¾§ä¼šå‡ºç°<b>æœ¬å¦/ä¹‹å¦</b>ã€å¦åï¼ŒåŠ<b>äº’/é”™/ç»¼</b>ä¿¡æ¯ï¼›æœ¬å¦åŒºåŸŸè¿˜æä¾›<b>åŠ¨çˆ»ç›´è¾¾</b>æŸ¥åŸæ–‡ã€‚<br>
      5ï¼‰éœ€è¦é˜…è¯»åˆ¤è¾æ—¶ï¼Œç‚¹<b>è§£å¦ï¼ˆæœ±ç†¹ï¼‰</b>ï¼Œé‡Œé¢ä¼šæ˜ç¡®å‘Šè¯‰ä½ ï¼š<b>ç°åœ¨åº”è¯¥è¯»å“ªä¸€æ®µã€å…ˆè¯»è°ã€ä¸ºä»€ä¹ˆ</b>ã€‚<br>
      6ï¼‰è‹¥è¦ä¿å­˜æˆ–åˆ†äº«ï¼Œç‚¹<b>å¤åˆ¶ç»“æœ</b>ï¼ˆå¯é€‰æ‹©æ˜¯å¦åŒ…å«â€œä¸‰å˜æ˜ç»†â€ï¼‰ã€‚
      <br><br>
      <b>å®åœ¨ä¸ä¼šè§£ï¼Ÿä¸€é”®ç”¨ AI</b><br>
      Â· ç‚¹å‡»<b>å¤åˆ¶ç»“æœ</b> â†’ ç²˜è´´ç»™ä½ çš„ AI åŠ©æ‰‹ â†’ è¯´ï¼šâ€œ<i>è¯·æŒ‰æœ±ç†¹æ³•ï¼Œå‘Šè¯‰æˆ‘åº”è¯»å“ªæ®µå¦è¾/çˆ»è¾ï¼Œå¹¶ç»™å‡ºå¤„ä¸è¦ç‚¹</i>â€ã€‚<br>
      Â· ä¹Ÿå¯ä»¥è¿½åŠ ï¼šâ€œ<i>ç»“åˆæˆ‘æå‡ºçš„é—®é¢˜ï¼Œç»™ä¸€ä¸ªé€šä¿—çš„è§£è¯»ä¸åº”å¯¹å»ºè®®ï¼ˆéè¿·ä¿¡ï¼‰</i>â€ã€‚
    </div>

    <div class="hr"></div>

    <div class="small" style="line-height:1.85">
      <b>å¤§è¡ç­®æ³• Â· ç®€ä»‹ï¼ˆæ¥å† / åœ°ä½ / ç†å¿µ / é€»è¾‘ï¼‰</b><br>
      Â· <u>æ¥å†</u>ï¼šæºå‡ºã€Šæ˜“ã€‹ä¹‹ç­®æ³•ä¼ ç»Ÿï¼Œå…ˆç§¦å·²æˆä½“ç³»ï¼Œå†ç»ä¸¤æ±‰æ³¨ç–ä¸å®‹ä»£ç†å­¦å®¶æ•´ç†æµä¼ ï¼›â€œå¤§è¡â€æ„æŒ‡ç”Ÿæˆä¹‹æ•°ä¸ä¸‡ç‰©åŒ–ç”Ÿä¹‹ç†ã€‚<br>
      Â· <u>åœ°ä½</u>ï¼šæ˜¯ä¼ ç»Ÿå ç­®ä¸­è¾ƒä¸ºè§„èŒƒã€ä¸¥è°¨çš„ä¸€å¥—<b>è±¡æ•°</b>æ“ä½œç¨‹åºï¼Œç”¨ä»¥ä»â€œå˜â€ä¸­å–ä¹‰ï¼Œé…åˆã€Šæ˜“ç»ã€‹æ–‡æœ¬ï¼ˆå¦è¾ã€çˆ»è¾ã€è±¡ä¼ ï¼‰åŠ ä»¥ä½“ä¼šã€‚<br>
      Â· <u>ç†å¿µ</u>ï¼šé‡åœ¨<b>é˜´é˜³åŠ¨é™ã€æ—¶ä½å¾—å¤±</b>ä¹‹è¾¨ï¼›ä»¥â€œæ•°â€å‘ˆâ€œè±¡â€ï¼Œä»¥â€œè±¡â€å–â€œä¹‰â€ï¼Œå¼ºè°ƒ<b>å› æ—¶åˆ¶å®œ</b>ä¸<b>åæ€è‡ªå¤„</b>ï¼Œå¹¶éå®¿å‘½å†³å®šã€‚<br>
      Â· <u>é€»è¾‘</u>ï¼šä»¥ 49 æ”¯è“è‰èµ·ç®—ï¼›æ¯çˆ»â€œä¸‰å˜â€å®šä¸€æ•°ï¼ˆ6/7/8/9ï¼‰ï¼Œå…­çˆ»è‡ªä¸‹è€Œä¸Šæˆå¦ï¼›é‡ 6/9 ä¸º<b>åŠ¨çˆ»</b>åˆ™å˜ä¸º<b>ä¹‹å¦</b>ï¼›å†æŒ‰æ–¹æ³•ï¼ˆå¦‚æœ±ç†¹æ³•ï¼‰<b>å†³å®šè¯»å“ªæ®µæ–‡æœ¬</b>ä»¥å–ä¹‰ã€‚
    </div>

    <div class="hr"></div>
    <div style="text-align:right">
      <button class="btn small" id="guideClose">å…³é—­</button>
    </div>
  </div>
</div>

<!-- è§£å¦ï¼ˆæœ±ç†¹ï¼‰ï¼šæ›´æ¸…æ¥šçš„â€œè¦åšä»€ä¹ˆâ€ + AI æç¤ºç´§éšå…¶å -->
<div class="modal" id="methodModal" role="dialog" aria-modal="true" aria-labelledby="methodTitle">
  <div class="box" tabindex="-1">
    <div id="methodTitle" class="title">å¦‚ä½•è§£å¦ Â· æœ±ç†¹æ³•</div>
    <div class="hr"></div>
    <div id="methodSummary" class="small"></div>

    <div class="hr"></div>
    <div class="small muted">
      è§„åˆ™é€Ÿè®°ï¼ˆä¾›å‚è€ƒï¼‰ï¼š<br>
      â‘  å…­çˆ»é™â†’è¯»<b>æœ¬å¦å¦è¾</b>ï¼›â‘¡ ä¸€åŠ¨â†’è¯»<b>è¯¥åŠ¨çˆ»çˆ»è¾</b>ï¼›â‘¢ äºŒåŠ¨â†’è¯»<b>ä¸¤åŠ¨çˆ»çˆ»è¾</b>ï¼ˆä»¥ä¸Šçˆ»ä¸ºä¸»ï¼‰ï¼›<br>
      â‘£ ä¸‰åŠ¨â†’è¯»<b>æœ¬å¦å¦è¾ï¼ˆè´ï¼‰+ä¹‹å¦å¦è¾ï¼ˆæ‚”ï¼‰</b>ï¼ˆå«åˆçˆ»ï¼å‰åï¼Œä»¥æœ¬å¦ä¸ºä¸»ï¼›ä¸å«åˆçˆ»ï¼ååï¼Œä»¥ä¹‹å¦ä¸ºä¸»ï¼‰ï¼›<br>
      â‘¤ å››åŠ¨â†’è¯»<b>ä¹‹å¦ä¸­ä¸¤é™çˆ»</b>ï¼ˆä»¥ä¸‹çˆ»ä¸ºä¸»ï¼‰ï¼›â‘¥ äº”åŠ¨â†’è¯»<b>ä¹‹å¦å”¯ä¸€é™çˆ»</b>ï¼›â‘¦ å…­åˆâ†’ä¹¾/å¤å–<b>ç”¨ä¹/ç”¨å…­</b>ï¼Œå…¶ä½™è¯»<b>ä¹‹å¦å¦è¾</b>ã€‚
    </div>

    <div class="hr"></div>
    <div class="small" id="demoArea">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="muted">ç¤ºä¾‹æ¼”ç»ƒï¼šéšæœº 1ï½2 åŠ¨çˆ»ï¼Œä»…æ¼”ç¤ºâ€œè¯»å“ªæ®µâ€ï¼Œä¸æ”¹å˜ä½ å½“å‰èµ·å¦ã€‚</span>
        <button class="btn small" id="demoBtn">ç”Ÿæˆç¤ºä¾‹</button>
      </div>
      <pre id="demoOut" class="mono" style="margin-top:8px"></pre>
    </div>

    <div style="text-align:right;margin-top:6px">
      <button class="btn small" id="methodClose">å…³é—­</button>
    </div>
  </div>
</div>

<script>
/* ========= ç‰ˆæœ¬ä¸æ„å»º ========= */
const APP_VERSION = "v5.0.1";
let   BUILD_SHA256 = "";
const __appendVersionToCommit = true;

async function sha256Hex(s){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest("SHA-256", enc.encode(s));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join(""); }
async function computeBuildHashOnce(){
  if (BUILD_SHA256) return BUILD_SHA256;
  BUILD_SHA256 = await sha256Hex(document.documentElement.outerHTML);
  return BUILD_SHA256;
}
function cryptoNonceHex(bytes=16){ const u=new Uint8Array(bytes); crypto.getRandomValues(u); return Array.from(u).map(b=>b.toString(16).padStart(2,"0")).join(""); }

/* ========= å¼ºéšæœº RNG ========= */
function cryptoRng(){ const u32=new Uint32Array(1); return ()=>{ crypto.getRandomValues(u32); return (u32[0]>>>0)/2**32; }; }
function randIntInclusive(rng,a,b){ const u=rng(); return Math.floor(u*(b-a+1))+a; }
function mulberry32(seed){ let t = seed >>> 0; return () => { t += 0x6D2B79F5; let r = Math.imul(t ^ (t >>> 15), (t | 1)); r ^= r + Math.imul(r ^ (r >>> 7), (r | 61)); return ((r ^ (r >>> 14)) >>> 0) / 4294967296; }; }
function newSeed32(){ const u=new Uint32Array(1); crypto.getRandomValues(u); return (u[0]>>>0)||1; }

/* ========= å†™å®åˆ†å †ï¼ˆä¸¥æ ¼ä¸‰å˜ï¼‰ ========= */
function rem4NonZero(x){ const r=x%4; return r===0?4:r; }
function splitNonZero(total, rng){ const A=randIntInclusive(rng,1,total-1); return [A,total-A]; }
function firstChange(n, rng){
  const [A,B] = splitNonZero(n, rng);
  const leftRem  = rem4NonZero(A);
  const rightRem = rem4NonZero(B-1); // å…ˆæŒ‚ä¸€
  const taken = 1 + leftRem + rightRem; // 5 æˆ– 9
  return { after:n-taken, step:{from:n,to:n-taken,A,B,leftRem,rightRem,taken,kind:"ç¬¬1å˜ï¼ˆæŒ‚ä¸€ï¼‰"} };
}
function nextChange(n, rng){
  const [A,B] = splitNonZero(n, rng);
  const leftRem  = rem4NonZero(A);
  const rightRem = rem4NonZero(B);
  const taken = leftRem + rightRem; // 4 æˆ– 8
  return { after:n-taken, step:{from:n,to:n-taken,A,B,leftRem,rightRem,taken,kind:"åç»­å˜"} };
}
function remainingToLine(n){
  if(n===24) return 6;
  if(n===28) return 7;
  if(n===32) return 8;
  if(n===36) return 9;
  throw new Error("Unexpected remainder: "+n);
}
function genOneStep(n, idx, rng){ return (idx===1) ? firstChange(n, rng) : nextChange(n, rng); }
function genLineYarrow(rng){
  let n=49; const t1=firstChange(n,rng); n=t1.after;
  const t2=nextChange(n,rng); n=t2.after;
  const t3=nextChange(n,rng); n=t3.after;
  return { value:remainingToLine(n) };
}

/* ========= å¦è¿ç®— & åç§° ========= */
function isYang(v){ return v===7||v===9; }
function isMoving(v){ return v===6||v===9; }
function toBinary(lines){ return lines.map(v=>isYang(v)?1:0); } // åº•â†’é¡¶
function relatingFrom(lines){ const out=lines.slice(); for(let i=0;i<6;i++){ if(lines[i]===6) out[i]=7; else if(lines[i]===9) out[i]=8; } return out; }
function nuclearFromBinary(b){ return [b[1],b[2],b[3], b[2],b[3],b[4]]; }
function invertedFromBinary(b){ return [b[5],b[4],b[3],b[2],b[1],b[0]]; }
function oppositeFromBinary(b){ return b.map(x=>x?0:1); }

const TRIS = {"111":{zh:"ä¹¾",sym:"â˜°"},"110":{zh:"å…‘",sym:"â˜±"},"101":{zh:"ç¦»",sym:"â˜²"},"100":{zh:"éœ‡",sym:"â˜³"},
"011":{zh:"å·½",sym:"â˜´"},"010":{zh:"å",sym:"â˜µ"},"001":{zh:"è‰®",sym:"â˜¶"},"000":{zh:"å¤",sym:"â˜·"}};
function triNameOf(b3){ const k=b3.join(""); return TRIS[k]?`${TRIS[k].sym}${TRIS[k].zh}`:k; }
function trisOf(bin){ const lower=bin.slice(0,3), upper=bin.slice(3,6); return {lower,upper}; }

/* 64å¦æ˜ å°„ï¼ˆå«ä¿®æ­£ï¼š12 å¦ï¼‰ */
const HEX64 = {
"111111":{no:1,zh:"ä¹¾",full:"ä¹¾ä¸ºå¤©"},"000000":{no:2,zh:"å¤",full:"å¤ä¸ºåœ°"},"100010":{no:3,zh:"å±¯",full:"æ°´é›·å±¯"},
"010001":{no:4,zh:"è’™",full:"å±±æ°´è’™"},"111010":{no:5,zh:"éœ€",full:"æ°´å¤©éœ€"},"010111":{no:6,zh:"è®¼",full:"å¤©æ°´è®¼"},
"010000":{no:7,zh:"å¸ˆ",full:"åœ°æ°´å¸ˆ"},"000010":{no:8,zh:"æ¯”",full:"æ°´åœ°æ¯”"},"111011":{no:9,zh:"å°ç•œ",full:"é£å¤©å°ç•œ"},
"110111":{no:10,zh:"å±¥",full:"å¤©æ³½å±¥"},"111000":{no:11,zh:"æ³°",full:"åœ°å¤©æ³°"},"000111":{no:12,zh:"å¦",full:"å¤©åœ°å¦"},
"101111":{no:13,zh:"åŒäºº",full:"å¤©ç«åŒäºº"},"111101":{no:14,zh:"å¤§æœ‰",full:"ç«å¤©å¤§æœ‰"},"001000":{no:15,zh:"è°¦",full:"åœ°å±±è°¦"},
"000100":{no:16,zh:"è±«",full:"é›·åœ°è±«"},"100110":{no:17,zh:"éš",full:"æ³½é›·éš"},"011001":{no:18,zh:"è›Š",full:"å±±é£è›Š"},
"110000":{no:19,zh:"ä¸´",full:"åœ°æ³½ä¸´"},"000011":{no:20,zh:"è§‚",full:"é£åœ°è§‚"},"100101":{no:21,zh:"å™¬å—‘",full:"ç«é›·å™¬å—‘"},
"101001":{no:22,zh:"è´²",full:"å±±ç«è´²"},"000001":{no:23,zh:"å‰¥",full:"å±±åœ°å‰¥"},"100000":{no:24,zh:"å¤",full:"åœ°é›·å¤"},
"100111":{no:25,zh:"æ— å¦„",full:"å¤©é›·æ— å¦„"},"111001":{no:26,zh:"å¤§ç•œ",full:"å±±å¤©å¤§ç•œ"},"100001":{no:27,zh:"é¢",full:"å±±é›·é¢"},
"011110":{no:28,zh:"å¤§è¿‡",full:"æ³½é£å¤§è¿‡"},"010010":{no:29,zh:"å",full:"åä¸ºæ°´"},"101101":{no:30,zh:"ç¦»",full:"ç¦»ä¸ºç«"},
"001110":{no:31,zh:"å’¸",full:"æ³½å±±å’¸"},"011100":{no:32,zh:"æ’",full:"é›·é£æ’"},"001111":{no:33,zh:"é¯",full:"å¤©å±±é¯"},
"111100":{no:34,zh:"å¤§å£®",full:"é›·å¤©å¤§å£®"},"000101":{no:35,zh:"æ™‹",full:"ç«åœ°æ™‹"},"101000":{no:36,zh:"æ˜å¤·",full:"åœ°ç«æ˜å¤·"},
"101011":{no:37,zh:"å®¶äºº",full:"é£ç«å®¶äºº"},"110101":{no:38,zh:"ç½",full:"ç«æ³½ç½"},"001010":{no:39,zh:"è¹‡",full:"æ°´å±±è¹‡"},
"010100":{no:40,zh:"è§£",full:"é›·æ°´è§£"},"110001":{no:41,zh:"æŸ",full:"å±±æ³½æŸ"},"100011":{no:42,zh:"ç›Š",full:"é£é›·ç›Š"},
"111110":{no:43,zh:"å¤¬",full:"æ³½å¤©å¤¬"},"011111":{no:44,zh:"å§¤",full:"å¤©é£å§¤"},"000110":{no:45,"zh":"èƒ","full":"æ³½åœ°èƒ"},
"011000":{no:46,zh:"å‡",full:"åœ°é£å‡"},"010110":{no:47,zh:"å›°",full:"æ³½æ°´å›°"},"011010":{no:48,zh:"äº•",full:"æ°´é£äº•"},
"101110":{no:49,zh:"é©",full:"æ³½ç«é©"},"011101":{no:50,zh:"é¼",full:"ç«é£é¼"},"100100":{no:51,zh:"éœ‡",full:"éœ‡ä¸ºé›·"},
"001001":{no:52,zh:"è‰®",full:"è‰®ä¸ºå±±"},"001011":{no:53,zh:"æ¸",full:"é£å±±æ¸"},"110100":{no:54,zh:"å½’å¦¹",full:"é›·æ³½å½’å¦¹"},
"101100":{no:55,zh:"ä¸°",full:"é›·ç«ä¸°"},"001101":{no:56,zh:"æ—…",full:"ç«å±±æ—…"},"011011":{no:57,zh:"å·½",full:"å·½ä¸ºé£"},
"110110":{no:58,zh:"å…‘",full:"å…‘ä¸ºæ³½"},"010011":{no:59,zh:"æ¶£",full:"é£æ°´æ¶£"},"110010":{no:60,zh:"èŠ‚",full:"æ°´æ³½èŠ‚"},
"110011":{no:61,zh:"ä¸­å­š",full:"é£æ³½ä¸­å­š"},"001100":{no:62,zh:"å°è¿‡",full:"é›·å±±å°è¿‡"},"101010":{no:63,zh:"æ—¢æµ",full:"æ°´ç«æ—¢æµ"},
"010101":{no:64,zh:"æœªæµ",full:"ç«æ°´æœªæµ"}
};
const TRIGRAM_ELEM = {"111":"å¤©","110":"æ³½","101":"ç«","100":"é›·","011":"é£","010":"æ°´","001":"å±±","000":"åœ°"};
(function validateHexMap(){
  Object.entries(HEX64).forEach(([k,v])=>{
    if(!v || typeof v!=="object") return;
    const bits=k.split("").map(x=>x==="1"?1:0);
    const up=bits.slice(3,6).join(""), low=bits.slice(0,3).join("");
    HEX64[k]={...v, zh:v.zh||"", full:v.full||`${TRIGRAM_ELEM[up]||""}${TRIGRAM_ELEM[low]||""}${v.zh||""}`};
  });
})();
function hexInfoOf(bin){ const k=Array.isArray(bin)?bin.join(""):String(bin); return HEX64[k]||null; }
function hexLabel(bin){
  const key = Array.isArray(bin) ? bin.join("") : String(bin);
  const info = HEX64[key]; if(!info) return `æœªæ”¶å½•ï¼ˆ${key}ï¼‰`;
  const bits = Array.isArray(bin)?bin.slice():key.split("").map(x=>x==="1"?1:0);
  const up=bits.slice(3,6).join(""), low=bits.slice(0,3).join("");
  const short=info.zh||"", full=info.full||`${TRIGRAM_ELEM[up]||""}${TRIGRAM_ELEM[low]||""}${short}`;
  return `${info.no}. ${full}ã€Œ${short}ã€`;
}

/* ========= UI refs ========= */
const $ = s=>document.querySelector(s);
const elStart=$("#startHex"), elSplit=$("#splitOnce"), elNextLine=$("#nextLine"), elReset=$("#resetAll");
const elStatus=$("#status");
const elCurrInfo=$("#currInfo"), elCurrDetail=$("#currDetail");
const elBuilt=$("#builtLines"), elBuiltText=$("#builtText");
const elMain=$("#mainHex"), elRel=$("#relHex"), elTriM=$("#triMain"), elTriR=$("#triRel"), elMore=$("#moreHex");
const elLabelMain=$("#labelMain"), elLabelRel=$("#labelRel");
const elVRS=$("#vrs"), verpill=$("#verpill");
const elN=$("#N"), elCheck=$("#check"), elStat=$("#stat"), elWarn=$("#statWarn");
const guideBtn=$("#guideBtn"), guideModal=$("#guideModal"), guideClose=$("#guideClose");
const methodBtn=$("#methodBtn"), methodModal=$("#methodModal"), methodClose=$("#methodClose"), methodSummary=$("#methodSummary");
const linksMain=$("#linksMain"), linksRel=$("#linksRel");
const copyBtn=$("#copyBtn"), includeSteps=$("#includeSteps");
const demoBtn = document.getElementById("demoBtn"), demoOut = document.getElementById("demoOut");

/* ========= æ¸²æŸ“ ========= */
function renderOneLineVisual(v){
  const row=document.createElement("div"); row.className="one-line";
  const isY=(v===7||v===9), moving=(v===6||v===9);
  if(isY){ const bar=document.createElement("div"); bar.className="yang"; row.appendChild(bar); }
  else{ const yin=document.createElement("div"); yin.className="yin";
        yin.append(Object.assign(document.createElement("div"),{className:"seg"}),
                   Object.assign(document.createElement("div"),{className:"gap"}),
                   Object.assign(document.createElement("div"),{className:"seg"}));
        row.appendChild(yin); }
  const lab=document.createElement("div"); lab.className="small mono"; lab.textContent=String(v);
  if(moving){ const t=document.createElement("span"); t.className="tag"; t.textContent="åŠ¨"; lab.appendChild(t); }
  row.appendChild(lab); return row;
}
function renderLines(container, lines){
  container.innerHTML=""; const visual=lines.slice().reverse(); visual.forEach(v=>container.appendChild(renderOneLineVisual(v)));
}
function renderBuilt(lines){
  elBuilt.innerHTML="";
  if(!lines.length){ elBuiltText.textContent="å°šæ— æˆçˆ»ã€‚"; return; }
  lines.forEach(v=> elBuilt.appendChild(renderOneLineVisual(v)));
  elBuiltText.textContent = `ï¼ˆå·²æˆ ${lines.length}/6 çˆ»ï¼›ä»ä¸‹è€Œä¸Šï¼š${lines.join(", ")}ï¼‰`;
}
function renderTris(el, bin){
  const {lower,upper}=trisOf(bin);
  el.textContent=`ä¸‹å¦ï¼š${triNameOf(lower)}ã€€ä¸Šå¦ï¼š${triNameOf(upper)}ã€€ï¼ˆäºŒè¿›åˆ¶ åº•â†’é¡¶ï¼š${bin.join("")})`;
}
function renderMore(el,bMain){
  const bNuc=nuclearFromBinary(bMain), bOpp=oppositeFromBinary(bMain), bInv=invertedFromBinary(bMain);
  const line=(label,b)=>`${label}ï¼š${triNameOf(b.slice(0,3))}/${triNameOf(b.slice(3,6))}  ${b.join("")} ï½œ ${hexLabel(b)}`;
  el.textContent=[ line("äº’å¦",bNuc), line("é”™å¦",bOpp), line("ç»¼å¦",bInv) ].join("\n");
}

/* ========= å¤–éƒ¨é“¾æ¥ ========= */
const CN_POS = ["åˆ","äºŒ","ä¸‰","å››","äº”","ä¸Š"];
function buildLinks(targetEl, binArr, sourceLinesForMoving, opts = {}){
  const bin = Array.isArray(binArr) ? binArr : String(binArr).split("").map(x=>x==="1"?1:0);
  const info = hexInfoOf(bin.join(""));
  targetEl.innerHTML = "";
  if(!info) return;

  const name = info.zh;
  // å¦çº§åˆ«æ£€ç´¢é“¾æ¥
  const t=document.createElement("div");
  t.className="small muted";
  t.textContent="æŸ¥åŸæ–‡ / æ³¨ç–ï¼ˆå¤–éƒ¨ï¼‰ï¼š";
  targetEl.appendChild(t);
  const q = encodeURIComponent("å‘¨æ˜“ "+name);
  const links = [
    { t:"ç»´åŸº(ä¸­æ–‡)", url:`https://zh.wikipedia.org/w/index.php?search=${q}` },
    { t:"ç»´åŸºæ–‡åº“",    url:`https://zh.wikisource.org/w/index.php?search=${q}` },
    { t:"CTP",         url:`https://ctext.org/zh?searchu=${q}` },
    { t:"ç™¾åº¦",        url:`https://www.baidu.com/s?wd=${q}` },
    { t:"Bing",        url:`https://www.bing.com/search?q=${q}` },
  ];
  const box=document.createElement("div");
  links.forEach(L=>{
    const a=document.createElement("a");
    a.className="linkchip";
    a.href=L.url; a.target="_blank"; a.rel="noopener noreferrer";
    a.textContent=L.t;
    box.appendChild(a);
  });
  targetEl.appendChild(box);

  // åŠ¨çˆ»ç›´è¾¾ï¼ˆä»…åœ¨â€œæœ¬å¦â€ä½¿ç”¨ï¼šä¼ å…¥ sourceLinesForMoving æ‰ä¼šå‡ºç°ï¼‰
  if (Array.isArray(sourceLinesForMoving) && sourceLinesForMoving.some(isMoving)){
    const tip=document.createElement("div");
    tip.className="small muted";
    tip.style.marginTop="6px";
    tip.textContent = opts.movingLabel || "åŠ¨çˆ»ç›´è¾¾ï¼š";
    targetEl.appendChild(tip);

    const b2=document.createElement("div");
    sourceLinesForMoving.forEach((v,i)=>{
      if(isMoving(v)){
        const yao=(v===9)?"ä¹":"å…­";
        const pos=CN_POS[i];
        const qq=encodeURIComponent(`å‘¨æ˜“ ${name} ${yao}${pos} çˆ»è¾`);
        const a=document.createElement("a");
        a.className="linkchip";
        a.href=`https://www.bing.com/search?q=${qq}`;
        a.target="_blank"; a.rel="noopener noreferrer";
        a.textContent=`${yao}${pos}`;
        b2.appendChild(a);
      }
    });
    targetEl.appendChild(b2);
  }

  // é™çˆ»ç›´è¾¾ï¼ˆç”¨äºæœ±ç†¹æ³•å››åŠ¨/äº”åŠ¨ï¼šè¯»ä¹‹å¦ä¸­é™çˆ»ï¼›ä»…ç»™â€œä¹‹å¦â€ç”¨ï¼‰
  if (opts.staticIndices && opts.staticIndices.length){
    const tip=document.createElement("div");
    tip.className="small muted";
    tip.style.marginTop="6px";
    tip.textContent = opts.staticLabel || "é™çˆ»ç›´è¾¾ï¼š";
    targetEl.appendChild(tip);

    const b3=document.createElement("div");
    opts.staticIndices.forEach(i=>{
      const yao = (bin[i-1]===1) ? "ä¹" : "å…­";
      const pos = CN_POS[i-1];
      const qq  = encodeURIComponent(`å‘¨æ˜“ ${name} ${yao}${pos} çˆ»è¾`);
      const a   = document.createElement("a");
      a.className="linkchip";
      a.href=`https://www.bing.com/search?q=${qq}`;
      a.target="_blank"; a.rel="noopener noreferrer";
      a.textContent = `${yao}${pos}`;
      b3.appendChild(a);
    });
    targetEl.appendChild(b3);
  }
}

/* ========= äº¤äº’çŠ¶æ€ ========= */
const state = { rng: cryptoRng(), sessionNonce: "", lines: [], hexDetail: [], curr: null, finished: false };

/* ========= å¤åˆ¶æ„å»º ========= */
function buildExportText(includeDetails){
  if(!state.finished) return "ï¼ˆå°šæœªå®Œæˆå…­çˆ»ï¼Œæ— æ³•å¯¼å‡ºï¼‰";
  const ts = new Date().toLocaleString();
  const mainBin = toBinary(state.lines);
  const relating = relatingFrom(state.lines);
  const binRel = toBinary(relating);
  const mainLbl = hexLabel(mainBin);
  const relLbl  = hexLabel(binRel);
  const {lower:lm, upper:um} = trisOf(mainBin);
  const {lower:lr, upper:ur} = trisOf(binRel);
  const movIdx = state.lines.map((v,i)=> (v===6||v===9)? i+1 : null).filter(Boolean);
  const movTxt = movIdx.length? ("ç¬¬ "+movIdx.join("ã€")+" çˆ»") : "ï¼ˆæ— ï¼‰";
  const advice = zhuXiAdvice(state.lines);

  let s = "";
  s += `å¤§è¡ç­®æ³• Â· èµ·å¦ç»“æœ\n`;
  s += `æ—¶é—´ï¼š${ts}\nç‰ˆæœ¬ï¼š${APP_VERSION}\nVRSï¼š${document.getElementById("vrs").textContent}\n`;
  s += `â€”â€”\n`;
  s += `æœ¬å¦ï¼š${mainLbl}ï½œäºŒè¿›åˆ¶ï¼š${mainBin.join("")}ï½œä¸‹å¦ï¼š${triNameOf(lm)} ä¸Šå¦ï¼š${triNameOf(um)}\n`;
  s += `ä¹‹å¦ï¼š${relLbl}ï½œäºŒè¿›åˆ¶ï¼š${binRel.join("")}ï½œä¸‹å¦ï¼š${triNameOf(lr)} ä¸Šå¦ï¼š${triNameOf(ur)}\n`;
  const bNuc=nuclearFromBinary(mainBin), bOpp=oppositeFromBinary(mainBin), bInv=invertedFromBinary(mainBin);
  s += `äº’å¦ï¼š${hexLabel(bNuc)}ï½œé”™å¦ï¼š${hexLabel(bOpp)}ï½œç»¼å¦ï¼š${hexLabel(bInv)}\n`;
  s += `â€”â€”\n`;
  s += `å…­çˆ»ï¼ˆè‡ªä¸‹è€Œä¸Šï¼‰ï¼š${state.lines.join(", ")}ï¼›åŠ¨çˆ»ï¼š${movTxt}\n`;
  s += `æœ±ç†¹åˆ¤è¯»ï¼š${advice.title}\n`;
  advice.read.forEach(r=>{ s += `Â· ${r.type}ï¼š${r.which}ï¼ˆæ‰€å±ï¼š${r.hex}ï¼‰\n`; });
  if(includeDetails){
    s += `â€”â€”\nä¸‰å˜æ˜ç»†ï¼ˆé€çˆ»ï¼‰\n`;
    state.hexDetail.forEach(d=>{
      s += `ç¬¬${d.line}çˆ»=${d.value}ï¼ˆä½™æ•°â†’${d.remainder}ï¼‰\n`;
      d.steps.forEach((st,i)=>{
        s += `  å˜${i+1}ï¼šfrom ${st.from} â†’ to ${st.to} ï½œ A=${st.A} B=${st.B} ï½œ å·¦ä½™=${st.leftRem} å³ä½™=${st.rightRem} ï½œ å–èµ°=${st.taken} ï½œ ${st.kind}\n`;
      });
    });
  }
  return s;
}
async function writeClipboard(text){
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text); return true;
    }
  }catch(e){}
  try{
    const ta=document.createElement("textarea");
    ta.value=text; ta.setAttribute("readonly",""); ta.style.position="fixed"; ta.style.top="-1000px";
    document.body.appendChild(ta); ta.select(); ta.setSelectionRange(0, ta.value.length);
    let ok=document.execCommand("copy"); document.body.removeChild(ta);
    if(!ok){
      const holder=document.createElement("pre"); holder.style.position="fixed"; holder.style.top="-1000px";
      holder.textContent=text; document.body.appendChild(holder);
      const range=document.createRange(); range.selectNodeContents(holder);
      const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
      ok=document.execCommand("copy"); sel.removeAllRanges(); holder.remove();
    }
    return ok;
  }catch(e){ return false; }
}

/* ========= åŸºæœ¬æµç¨‹ ========= */
function resetAll(){
  state.rng = cryptoRng(); state.sessionNonce = ""; state.lines = []; state.hexDetail = []; state.curr = null; state.finished = false;
  elStatus.textContent = "æœªå¼€å§‹ã€‚ç‚¹å‡»â€œå¼€å§‹ä¸€å¦â€ã€‚";
  elCurrInfo.textContent = ""; elCurrDetail.textContent = "";
  elMain.innerHTML = elRel.innerHTML = elMore.textContent = ""; elTriM.textContent = elTriR.textContent = "";
  linksMain.innerHTML = linksRel.innerHTML = ""; elLabelMain.textContent="æœ¬å¦"; elLabelRel.textContent="ä¹‹å¦";
  methodBtn.disabled = true; copyBtn.disabled = true;
  renderBuilt(state.lines); elSplit.disabled = elNextLine.disabled = true;
}
function startHex(){
  state.sessionNonce = cryptoNonceHex(16); state.lines = []; state.hexDetail = []; state.finished = false;
  startNewLine(); elStatus.innerHTML = `å·²å¼€å§‹æœ¬å¦ã€‚<span class="ok">å½“å‰çˆ»ï¼šç¬¬ ${state.lines.length+1} çˆ»ï¼ˆè‡ªä¸‹è€Œä¸Šï¼‰</span>`;
}
function startNewLine(){
  state.curr = { n:49, stepIdx:1, steps:[], done:false };
  updateCurrUI(); elSplit.disabled = false; elNextLine.disabled = true;
}
function updateCurrUI(){
  if(!state.curr){ elCurrInfo.textContent=""; elCurrDetail.textContent=""; return; }
  const idx = state.lines.length + (state.curr.done?0:1);
  const nextHint = state.curr.done ? "ï¼ˆæœ¬çˆ»å·²æˆï¼‰" : (state.curr.stepIdx===1?"ç¬¬1å˜ï¼ˆå…ˆæŒ‚ä¸€ï¼‰":"ç¬¬"+state.curr.stepIdx+"å˜");
  elCurrInfo.textContent = `å½“å‰çˆ»ï¼šç¬¬ ${idx} çˆ»ï½œç°æœ‰è“è‰æ•° n=${state.curr.n}ï½œ${ state.curr.done ? "ä¸‰å˜æ˜ç»†å¦‚ä¸‹" : "ä¸‹ä¸€æ­¥ï¼š"+nextHint }`;
  const display = state.curr.steps.map((s,i)=>({ å˜åº:i+1, ä»:s.from, åˆ°:s.to, A:s.A, B:s.B, å·¦ä½™:s.leftRem, å³ä½™:s.rightRem, å–èµ°:s.taken, æ ‡æ³¨:s.kind }));
  elCurrDetail.textContent = display.length ? JSON.stringify(display, null, 2) : "ï¼ˆç­‰å¾…åˆ†å †ï¼‰";
}
function doOneSplit(){
  const {n, stepIdx} = state.curr;
  const {after, step} = genOneStep(n, stepIdx, state.rng);
  step.idx = stepIdx; state.curr.steps.push(step); state.curr.n = after; state.curr.stepIdx++;

  if (state.curr.stepIdx===4){
    if (![24,28,32,36].includes(state.curr.n)){
      elStatus.innerHTML = `<span class="warn">åˆ†å †å¼‚å¸¸ï¼šå‰©ä½™ n=${state.curr.n}ï¼ˆåº”ä¸º 24/28/32/36ï¼‰ã€‚è¯·ç‚¹å‡»â€œé‡å¼€â€ã€‚</span>`;
      elSplit.disabled = true; elNextLine.disabled = true; return;
    }
    const value = remainingToLine(state.curr.n);
    state.lines.push(value);
    state.hexDetail.push({ line: state.lines.length, value, remainder: state.curr.n, steps: state.curr.steps.slice() });

    renderBuilt(state.lines);

    const idx = state.lines.length;
    elStatus.innerHTML = `ç¬¬ ${idx} çˆ»å·²æˆï¼š<b>${value}</b>ï¼ˆ${(value===7||value===9)?"é˜³":"é˜´"}${(value===6||value===9)?"Â·åŠ¨":""}ï¼‰ã€‚`;
    state.curr.done = true;
    updateCurrUI();

    elSplit.disabled = true;
    if (state.lines.length < 6){
      elNextLine.disabled = false;
    }else{
      elNextLine.disabled = true;
      finishHex();
    }
  }else{
    updateCurrUI();
  }
}

/* ========= å®Œæˆä¸€å¦ ========= */
async function finishHex(){
  const binMain = toBinary(state.lines);
  const relating = relatingFrom(state.lines);
  const binRel  = toBinary(relating);

  renderLines(elMain, state.lines);
  renderLines(elRel, relating);
  renderTris(elTriM, binMain);
  renderTris(elTriR, binRel);
  elLabelMain.textContent = `æœ¬å¦ï¼š` + hexLabel(binMain);
  elLabelRel.textContent  = `ä¹‹å¦ï¼š` + hexLabel(binRel);

  // å››/äº”åŠ¨ï¼šä¸ºä¹‹å¦æä¾›â€œé™çˆ»ç›´è¾¾â€
  const movIdx = movingIndices(state.lines); // 1..6
  let staticOnRel = [];
  if (movIdx.length === 4 || movIdx.length === 5){
    staticOnRel = [1,2,3,4,5,6].filter(i => !movIdx.includes(i));
  }

  // æœ¬å¦ï¼šå¦çº§ + åŠ¨çˆ»ç›´è¾¾
  buildLinks(linksMain, binMain, state.lines);

  // ä¹‹å¦ï¼šå¦çº§ + é™çˆ»ç›´è¾¾ï¼ˆä¸æ˜¾ç¤ºâ€œåŠ¨çˆ»ç›´è¾¾â€ï¼‰
  buildLinks(linksRel, binRel, undefined, {
    staticIndices: staticOnRel,
    staticLabel: "é™çˆ»ç›´è¾¾ï¼ˆä¹‹å¦ï¼‰"
  });

  const bNuc = nuclearFromBinary(binMain);
  const bOpp = oppositeFromBinary(binMain);
  const bInv = invertedFromBinary(binMain);
  const line = (label,b)=>`${label}ï¼š${triNameOf(b.slice(0,3))}/${triNameOf(b.slice(3,6))}  ${b.join("")} ï½œ ${hexLabel(b)}`;
  elMore.textContent = [ line("äº’å¦",bNuc), line("é”™å¦",bOpp), line("ç»¼å¦",bInv) ].join("\n");

  state.finished = true;

  await computeBuildHashOnce();
  const epochMs = Date.now();
  const bodyHash = await sha256Hex(JSON.stringify({lines:state.lines, detail:state.hexDetail}));
  const commitStr = (__appendVersionToCommit ? `${APP_VERSION}|${BUILD_SHA256}|` : "") + `nonce:${state.sessionNonce}|t:${epochMs}|body:${bodyHash}`;
  elVRS.textContent = (await sha256Hex(commitStr)).slice(0,16)+"â€¦";

  methodBtn.disabled = false;
  copyBtn.disabled = false;
  elStatus.innerHTML = `<span class="ok">å…¨å¦å®Œæˆã€‚</span> å¯ç‚¹<b>è§£å¦ï¼ˆæœ±ç†¹ï¼‰</b>æŸ¥çœ‹åˆ¤è¯»è·¯å¾„ï¼Œæˆ–<b>å¤åˆ¶ç»“æœ</b>ä¿å­˜/åˆ†äº«ã€‚`;
}

/* ========= æœ±ç†¹å æ–­ï¼ˆå«å‰å/ååï¼‰ ========= */
function movingIndices(lines){ const out=[]; for(let i=0;i<6;i++){ if(isMoving(lines[i])) out.push(i+1); } return out; }
function zhuXiAdvice(lines){
  const mov = movingIndices(lines); const m = mov.length;
  const mainBin = toBinary(lines);
  const relateBin= toBinary(relatingFrom(lines));
  const mainLbl  = hexLabel(mainBin);
  const relLbl   = hexLabel(relateBin);

  if (m===0) return { title:"å…­çˆ»çš†é™ï¼šè¯»æœ¬å¦å¦è¾", read:[{type:"å¦è¾", which:"æœ¬å¦å¦è¾ï¼ˆå¹¶å¯å‚ã€Šå¤§è±¡ã€‹ï¼‰", hex:mainLbl}], why:"æ²¡æœ‰åŠ¨çˆ»ï¼Œéœ€è¦æ•´ä½“ä¹‹ä¹‰" };
  if (m===1) return { title:`ä¸€çˆ»åŠ¨ï¼šè¯»è¯¥åŠ¨çˆ»çˆ»è¾ï¼ˆæœ¬å¦ï¼‰`, read:[{type:"çˆ»è¾", which:`æœ¬å¦ç¬¬ ${mov[0]} çˆ»çš„çˆ»è¾`, hex:mainLbl}], why:"åªæœ‰ä¸€å¤„å˜åŒ–ï¼Œå–å…¶çˆ»è¾" };
  if (m===2){ const hi=Math.max(mov[0],mov[1]); return { title:`äºŒçˆ»åŠ¨ï¼šä¸¤çˆ»çš†è¯»ï¼ˆä»¥ä¸Šçˆ»ä¸ºä¸»ï¼‰`, read:[{type:"çˆ»è¾", which:`æœ¬å¦ç¬¬ ${mov[0]}ã€ç¬¬ ${mov[1]} çˆ»ï¼ˆä¸»ï¼šç¬¬ ${hi} çˆ»ï¼‰`, hex:mainLbl}], why:"ä¸¤å¤„å˜åŒ–ï¼Œä»¥ä¸Šçˆ»ä¸ºä¸»" }; }
  if (m===3){
    const frontTen = mov.includes(1);
    const titleTail = frontTen ? "ï¼ˆå‰åï¼šä»¥æœ¬å¦ä¸ºä¸»ï¼‰" : "ï¼ˆååï¼šä»¥ä¹‹å¦ä¸ºä¸»ï¼‰";
    const read = frontTen
      ? [{type:"å¦è¾", which:"æœ¬å¦å¦è¾ï¼ˆè´ï¼‰", hex:mainLbl}, {type:"å¦è¾", which:"ä¹‹å¦å¦è¾ï¼ˆæ‚”ï¼‰", hex:relLbl}]
      : [{type:"å¦è¾", which:"ä¹‹å¦å¦è¾ï¼ˆæ‚”ï¼‰", hex:relLbl}, {type:"å¦è¾", which:"æœ¬å¦å¦è¾ï¼ˆè´ï¼‰", hex:mainLbl}];
    return { title:"ä¸‰çˆ»åŠ¨ï¼š"+titleTail, read, why: frontTen?"å«åˆçˆ»ï¼Œåé‡æœ¬å¦":"ä¸å«åˆçˆ»ï¼Œåé‡ä¹‹å¦" };
  }
  if (m===4){
    const stat=[1,2,3,4,5,6].filter(i=>!mov.includes(i)); const main=Math.min(stat[0],stat[1]);
    return { title:"å››çˆ»åŠ¨ï¼šè¯»å˜å¦ä¸­ä¸¤é™çˆ»ï¼ˆä»¥ä¸‹çˆ»ä¸ºä¸»ï¼‰", read:[{type:"çˆ»è¾", which:`ä¹‹å¦ç¬¬ ${stat[0]}ã€ç¬¬ ${stat[1]} çˆ»ï¼ˆä¸»ï¼šç¬¬ ${main} çˆ»ï¼‰`, hex:relLbl}], why:"åŠ¨å¤šé™å°‘ï¼Œå–ä¹‹å¦é™çˆ»ä»¥å®šä¹‰" };
  }
  if (m===5){
    const stat=[1,2,3,4,5,6].find(i=>!mov.includes(i));
    return { title:"äº”çˆ»åŠ¨ï¼šè¯»å˜å¦å”¯ä¸€é™çˆ»", read:[{type:"çˆ»è¾", which:`ä¹‹å¦ç¬¬ ${stat} çˆ»`, hex:relLbl}], why:"å‡ ä¹å…¨åŠ¨ï¼Œå”¯é™å¯æ®" };
  }
  if (m===6){
    const key=mainBin.join("");
    if(key==="111111") return { title:"å…­çˆ»çš†åŠ¨ï¼ˆæœ¬å¦ä¸ºä¹¾ï¼‰ï¼šç”¨ä¹", read:[{type:"ç”¨è¾", which:"ä¹¾å¦ã€ç”¨ä¹ã€", hex:"1. ä¹¾ä¸ºå¤©"}], why:"ä¹¾ç‰¹ä¾‹" };
    if(key==="000000") return { title:"å…­çˆ»çš†åŠ¨ï¼ˆæœ¬å¦ä¸ºå¤ï¼‰ï¼šç”¨å…­", read:[{type:"ç”¨è¾", which:"å¤å¦ã€ç”¨å…­ã€", hex:"2. å¤ä¸ºåœ°"}], why:"å¤ç‰¹ä¾‹" };
    return { title:"å…­çˆ»çš†åŠ¨ï¼šè¯»ä¹‹å¦å¦è¾", read:[{type:"å¦è¾", which:"ä¹‹å¦å¦è¾", hex:relLbl}], why:"å…¨å˜ï¼Œå–ä¹‹å¦ä¹‹ä¹‰" };
  }
  return { title:"â€”", read:[], why:"" };
}

/* ========= æ‰“å¼€è§£å¦é¢æ¿ï¼ˆæ›´æ¸…æ¥šçš„â€œè¦åšä»€ä¹ˆâ€+ AI æç¤ºç´§éšå…¶åï¼‰ ========= */
function openMethod(){
  if (!state.finished) return;
  const mov = movingIndices(state.lines);
  const mainBin = toBinary(state.lines);
  const relBin  = toBinary(relatingFrom(state.lines));
  const sum = zhuXiAdvice(state.lines);

  const movTxt = mov.length? ("ç¬¬ "+mov.join("ã€")+" çˆ»"):"ï¼ˆæ— ï¼‰";
  const stepsHtml = `
    <div class="small" style="line-height:1.9">
      <b>ä½ ç°åœ¨è¦åšçš„äº‹ï¼ˆä¸€æ­¥ä¸€æ­¥ï¼‰</b><br>
      1ï¼‰å…ˆç¡®è®¤<b>åŠ¨çˆ»</b>ï¼š${movTxt}<br>
      2ï¼‰æŒ‰ç…§ä¸‹åˆ—æ¸…å•é€æ¡é˜…è¯»ï¼ˆå…ˆä¸»åè¾…ï¼‰ï¼š<br>
      <ol style="margin:6px 0 0 18px">
        ${sum.read.map(r=>`<li>å»è¯»<b>${r.type}</b>ï¼š${r.which}ã€€<span class="muted">ï¼ˆæ‰€å±ï¼š${r.hex}ï¼‰</span></li>`).join("")}
      </ol>
      <div class="muted" style="margin-top:6px">ä¸ºä»€ä¹ˆè¿™æ ·è¯»ï¼š${sum.why || "ä¾æœ±ç†¹åˆ¤è¯»è§„åˆ™ï¼ˆè§ä¸‹â€œè§„åˆ™é€Ÿè®°â€ï¼‰"}</div>
    </div>
    <div class="ai-tip small">
      ğŸ’¡ <b>ç”¨ AI å¿«é€Ÿå®šä½ä¸è§£è¯»</b>ï¼šç‚¹â€œå¤åˆ¶ç»“æœâ€ï¼ŒæŠŠæ–‡æœ¬ç²˜è´´ç»™ä½ çš„ AI åŠ©æ‰‹ï¼Œå¹¶è¯´æ˜â€œ<i>æŒ‰æœ±ç†¹æ³•å‘Šè¯‰æˆ‘åº”è¯¥è¯»å“ªæ®µå¦è¾/çˆ»è¾ï¼Œç»™å‡ºå¤„ä¸è¦ç‚¹ï¼›è‹¥æ–¹ä¾¿ï¼Œè¯·ç»“åˆæˆ‘çš„é—®é¢˜ç»™é€šä¿—è§£è¯»ï¼ˆéè¿·ä¿¡ï¼‰</i>â€ã€‚<br>
      å»ºè®®é™„å¸¦ï¼šä½ èµ·å¦æ—¶å¿ƒä¸­æ‰€é—®ã€ç›¸å…³æƒ…å¢ƒä¸æ—¶é—´ã€‚
    </div>
  `;

  const headerHtml = `
    <div class="small" style="line-height:1.8">
      <b>å½“å‰ç»“æœä¸€çœ¼çœ‹æ‡‚</b><br>
      Â· åŠ¨çˆ»ï¼š${movTxt}<br>
      Â· æœ¬å¦ï¼š${hexLabel(mainBin)}<br>
      Â· ä¹‹å¦ï¼š${hexLabel(relBin)}
    </div>
  `;

  methodSummary.innerHTML = headerHtml + stepsHtml;
  methodModal.style.display="block";
  setTimeout(()=>methodModal.querySelector(".box").focus(),0);
}
function closeMethod(){ methodModal.style.display="none"; methodBtn?.focus(); }

/* ç¤ºä¾‹æ¼”ç»ƒï¼šéšæœº 1ï½2 åŠ¨çˆ»ï¼Œæ¼”ç¤ºâ€œè¯»å“ªæ®µâ€ï¼Œä¸æ”¹å˜å½“å‰ state */
function randomDemoLines(){
  const rng = mulberry32(newSeed32());
  const lines = Array.from({length:6}, ()=> (randIntInclusive(rng,0,1)?7:8));
  const m = randIntInclusive(rng,1,2);
  const idxs = [];
  while(idxs.length<m){
    const i = randIntInclusive(rng,1,6);
    if(!idxs.includes(i)) idxs.push(i);
  }
  idxs.forEach(i=>{ lines[i-1] = randIntInclusive(rng,0,1)?6:9; });
  return lines;
}
function renderDemo(){
  const lines = randomDemoLines();
  const mov = movingIndices(lines);
  const mainBin = toBinary(lines);
  const relBin  = toBinary(relatingFrom(lines));
  const sum = zhuXiAdvice(lines);

  let out = "";
  out += `ç¤ºä¾‹å…­çˆ»ï¼ˆè‡ªä¸‹è€Œä¸Šï¼‰ï¼š${lines.join(", ")}ï¼›åŠ¨çˆ»ï¼š${mov.length? ("ç¬¬ "+mov.join("ã€")+" çˆ»"):"ï¼ˆæ— ï¼‰"}\n`;
  out += `æœ¬å¦ï¼š${hexLabel(mainBin)}ï½œä¹‹å¦ï¼š${hexLabel(relBin)}\n`;
  out += `${sum.title}ï¼ˆç†ç”±ï¼š${sum.why||"è§„åˆ™æ‰€æŒ‡"}ï¼‰\n`;
  sum.read.forEach(r=>{ out += `Â· ${r.type}ï¼š${r.which}ï¼ˆæ‰€å±ï¼š${r.hex}ï¼‰\n`; });
  demoOut.textContent = out;
}

/* ========= æŒ‡å— ========= */
function openGuide(){ guideModal.style.display="block"; setTimeout(()=>guideModal.querySelector(".box").focus(),0); }
function closeGuide(){ guideModal.style.display="none"; guideBtn?.focus(); }

/* ========= è‡ªæ£€ ========= */
function pct(n,d){ return (n/d*100).toFixed(3)+"%"; }

/* ========= äº‹ä»¶ ========= */
document.getElementById("selftest").addEventListener("click", ()=>{
  const N = Math.max(1000, parseInt(elN.value,10)||100000);
  const rng = mulberry32(newSeed32());
  const cnt = {6:0,7:0,8:0,9:0};
  for(let i=0;i<N;i++){ const { value } = genLineYarrow(rng); cnt[value]++; }
  elStat.textContent =
    `æ ·æœ¬æ•° N = ${N}\n`+
    `è®¡æ•°ï¼š${JSON.stringify(cnt)}\n`+
    `æ¯”ä¾‹ï¼š{6:${pct(cnt[6],N)}, 7:${pct(cnt[7],N)}, 8:${pct(cnt[8],N)}, 9:${pct(cnt[9],N)}}\n`+
    `å‚è€ƒåŸºå‡†ï¼š{6:â‰ˆ1.3%, 7:â‰ˆ12.8%, 8:â‰ˆ41.6%, 9:â‰ˆ44.3%}`;
  const trendOK=(cnt[9]>=cnt[8])&&(cnt[8]>cnt[7])&&(cnt[7]>cnt[6]);
  elStat.textContent += `\nç»éªŒè¶‹åŠ¿æ£€æŸ¥ï¼š${ trendOK ? "ç¬¦åˆé•¿æœŸè¶‹åŠ¿ï¼ˆ9â‰¥8â‰«7>6ï¼‰" : "ä¸é•¿æœŸè¶‹åŠ¿ä¸ä¸€è‡´ï¼ˆå¯èƒ½æ ·æœ¬åå°æˆ–éšæœºæ³¢åŠ¨ï¼‰" }`;
  elCheck.style.display="block";
  elWarn.textContent = (N<50000) ? "æç¤ºï¼šæ ·æœ¬é‡è¾ƒå°ï¼Œæ³¢åŠ¨è¾ƒå¤§ï¼›å»ºè®® â‰¥ 100000ã€‚" : "";
});

elStart.addEventListener("click", ()=> startHex());
elSplit.addEventListener("click", ()=>{ if(state.curr) doOneSplit(); });
elNextLine.addEventListener("click", ()=>{ if(!state.curr || state.curr.done){ startNewLine(); elStatus.innerHTML = `ç»§ç»­èµ·å¦ã€‚å½“å‰çˆ»ï¼šç¬¬ ${state.lines.length+1} çˆ»ï¼ˆè‡ªä¸‹è€Œä¸Šï¼‰`; } });
elReset.addEventListener("click", ()=> resetAll());

/* é¢æ¿ç»‘å®š */
methodBtn.addEventListener("click", openMethod);
methodClose.addEventListener("click", closeMethod);
methodModal.addEventListener("click", (e)=>{ if(e.target===methodModal) closeMethod(); });
document.addEventListener("keydown",(e)=>{ if(methodModal.style.display==="block" && e.key==="Escape") closeMethod(); });

guideBtn.addEventListener("click", openGuide);
guideClose.addEventListener("click", closeGuide);
guideModal.addEventListener("click", (e)=>{ if(e.target===guideModal) closeGuide(); });
document.addEventListener("keydown",(e)=>{ if(guideModal.style.display==="block" && e.key==="Escape") closeGuide(); });

/* å¤åˆ¶æŒ‰é’® */
copyBtn.addEventListener("click", async ()=>{
  if(!state.finished){ alert("è¯·å…ˆå®Œæˆå…­çˆ»ã€‚"); return; }
  const text = buildExportText(includeSteps.checked);
  const ok = await writeClipboard(text);
  copyBtn.textContent = ok ? "å·²å¤åˆ¶ âœ“" : "å¤åˆ¶å¤±è´¥";
  copyBtn.disabled = ok ? true : false;
  setTimeout(()=>{ copyBtn.textContent = "å¤åˆ¶ç»“æœ"; copyBtn.disabled = false; }, 1200);
});

/* ç¤ºä¾‹æ¼”ç»ƒæŒ‰é’® */
demoBtn.addEventListener("click", renderDemo);

/* é”®ç›˜å¿«æ·ï¼šç©ºæ ¼/å›è½¦ = â€œåˆ†å †ï¼ˆä¸‹ä¸€å˜ï¼‰â€ï¼Œåœ¨å¼¹çª—æˆ–è¾“å…¥èšç„¦æ—¶ä¸è§¦å‘ */
document.addEventListener("keydown",(e)=>{
  const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : "";
  const inEditable = (e.target && (e.target.isContentEditable || tag==="INPUT" || tag==="TEXTAREA" || tag==="SELECT"));
  const modalOpen = (guideModal.style.display==="block" || methodModal.style.display==="block");
  if(inEditable || modalOpen) return;
  if ((e.key===" " || e.key==="Enter") && !state.finished && !elSplit.disabled){
    e.preventDefault(); elSplit.click();
  }
});

/* ========= åˆå§‹åŒ– ========= */
(async function init(){
  await computeBuildHashOnce();
  verpill.textContent = APP_VERSION+" Â· "+(BUILD_SHA256||"").slice(0,8)+"â€¦";
  resetAll();
})();
</script>
</body>
</html>
